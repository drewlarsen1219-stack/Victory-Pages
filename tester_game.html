<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPG Skill Tracker</title>
    <style>
        /* Essential Layout Styles Only */
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            font-family: sans-serif;
            /* Minimalist background */
            background-color: #ffffff; 
        }

        h1 {
            margin-bottom: 15px;
            font-size: 1.5em;
            color: #111;
        }

        /* 3 Across, 4 Down Grid */
        #grid-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px; /* Slightly larger gap */
            width: 300px;
            margin-bottom: 15px;
            padding: 5px;
            /* Border and background removed for minimalism */
            border: 1px solid #eee; 
            background-color: transparent;
            border-radius: 4px;
        }

        /* The button itself has no custom styling, just the necessary class */
        .score-button {
            cursor: pointer;
            padding: 8px 3px; 
            font-size: 10px;
            line-height: 1.2;
            text-align: center;
            white-space: pre-wrap; 
            /* Minimalist styling */
            background-color: #ffffff; 
            border: 1px solid #ccc;
            border-radius: 4px;
            transition: all 0.1s;
        }
        .score-button:hover:not(.selected) {
            /* Light grey hover */
            background-color: #f0f0f0; 
        }

        /* Minimal selection indicator (keeping red for clear feedback) */
        .score-button.selected {
            border: 2px solid #CC0000; 
            box-shadow: 0 0 4px rgba(204, 0, 0, 0.4);
            background-color: #ffffff;
        }

        /* Control Bar */
        #control-bar {
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 300px;
            padding: 5px;
        }
        
        #status-message {
            text-align: center;
            height: 1.2em;
            font-size: 0.9em;
            color: #333;
        }

        /* Input Group for NLP */
        #activity-input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 10px;
            /* Minimalist, focusing only on inputs */
            border: none;
            background-color: transparent;
        }

        textarea#activity-text-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            resize: none;
            font-size: 0.9em;
        }
        
        #excluded-skills-input, #manual-points-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.9em;
        }

        /* Minimalist Button Styling (Default Look) */
        button {
            padding: 8px 10px;
            background-color: #e0e0e0; /* Default light grey */
            color: #333;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-weight: normal; 
            font-size: 0.9em;
        }
        button:hover:not(:disabled) {
            background-color: #d0d0d0; 
        }
        button:disabled {
            background-color: #aaa;
            cursor: not-allowed;
        }
        
        /* Minimalist Recommendation Display */
        #recommendation-output {
            margin-top: 10px; 
            padding: 12px; 
            /* Subtly framed container */
            border: 1px solid #eee; 
            border-radius: 4px; 
            background-color: #f9f9f9;
            /* Added max-height and overflow to prevent external scrolling */
            max-height: 250px; 
            overflow-y: auto; 
        }
        #recommendation-text {
            font-size: 0.9em; 
            margin-bottom: 8px;
            white-space: pre-wrap; /* Allows raw text to handle line breaks */
        }

        #recommendation-editor {
            font-size: 0.9em;
            font-family: sans-serif;
        }

        /* Button group for tips/points controls */
        #recommendation-controls {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }
        
        /* Ensure the Apply button is pushed to the right when other buttons are visible */
        #apply-recommendation-btn {
            margin-left: auto;
        }

        /* Styling for the custom symbols (Larger and Tighter) */
        .skill-symbol {
            font-family: 'Courier New', Courier, monospace;
            font-weight: bold;
            font-size: 2em;
            display: inline-block;
            margin: 0;
            line-height: 1;
            color: #444;
        }
        
        #save-data-btn {
            background-color: #1a73e8;
            color: white;
            border: none;
            font-weight: bold;
        }
        #save-data-btn:hover {
            background-color: #1558b3;
        }
    </style>
</head>
<body>
    <h1>Skill Proficiency Tracker</h1>

    <!-- 12-Button Grid --><div id="grid-container">
        <!-- Buttons will be injected here by JavaScript --></div>

    <!-- Input Control Bar --><div id="control-bar">
        <div id="status-message">Initializing...</div>
        
        <!-- Manual Save Button -->
        <button id="save-data-btn">Save Now</button>
        
        <!-- New Activity Input Group -->
        <div id="activity-input-group">
            <textarea id="activity-text-input" rows="3" placeholder='e.g., "Attended Toastmasters for 8 hours this year..."'></textarea>
            
            <input type="text" id="manual-points-input" placeholder="Manual points (e.g., Mind: 5, Heart: 3)" title="Define point values for specific skills. The AI will calculate the rest.">

            <input type="text" id="excluded-skills-input" placeholder="Exclude AI skills (e.g., Soul, Body)" title="Enter a comma-separated list of skills for the AI to ignore. Manual points override this.">
            
            <button id="analyze-activity-btn">Analyze & Get Recommendation</button>
        </div>
        
        <!-- NEW: Recommendation Display - Used for BOTH points and tips -->
        <div id="recommendation-output" style="display:none;">
            
            <div id="recommendation-display-area">
                <div id="recommendation-text"></div>
                <!-- Editor hidden until 'Edit Tips' is clicked -->
                <textarea id="recommendation-editor" style="display:none; width: 100%; height: 200px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; resize: none;"></textarea>
            </div>
            
            <div id="recommendation-controls">
                <button id="edit-tips-btn" style="display:none;">Edit Tips</button>
                <button id="save-tips-btn" style="display:none;">Save Tips</button>
                <button id="cancel-edit-btn" style="display:none;">Cancel</button>
                <button id="apply-recommendation-btn" style="display:none;">Apply Recommendation</button>
            </div>

        </div>

        <!-- The original single-point input is hidden to focus on the new NLP feature -->
        <div class="input-group" style="display: none;">
            <input type="number" id="point-input" min="1" max="100" placeholder="Points to add (max 100)">
            <button id="add-score-btn" disabled>Add Score</button>
        </div>
    </div>

    <script type="module">
        // --- FIREBASE IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GEMINI API SETUP (Unused for tips, but kept for Analysis function) ---
        const apiKey = ""; 
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // --- FIREBASE GLOBAL STATE ---
        let db = null;
        let auth = null;
        let userId = null;
        let isFirebaseReady = false;

        // --- SKILL AND RANK DEFINITIONS ---
        const SKILL_DATA = [
            { name: 'Body', symbol: '⇗', rankNames: ['Newbie', 'Apprentice', 'Journeyman', 'Expert', 'Master', 'Grandmaster', 'Legend'] }, // Rising Power Arrow (Strength)
            { name: 'Mind', symbol: '◎', rankNames: ['Newbie', 'Learner', 'Scholar', 'Thinker', 'Sage', 'Guru', 'Oracle'] }, // Eye/Target
            { name: 'Heart', symbol: '♥', rankNames: ['Newbie', 'Helper', 'Friend', 'Connector', 'Mentor', 'Community Lead', 'Empath'] }, // Heart Suit
            { name: 'Hand', symbol: '⌸', rankNames: ['Newbie', 'Tinkerer', 'Builder', 'Creator', 'Artisan', 'Inventor', 'Polymath'] }, // Workbench/Block (Crafting)
            { name: 'Finance', symbol: '$', rankNames: ['Newbie', 'Earner', 'Saver', 'Investor', 'Financier', 'Tycoon', 'Croesus'] }, // Dollar/Currency
            { name: 'Soul', symbol: '†', rankNames: ['Damned', 'Saved', 'Saint/Sinner', 'Saved', 'Saved', 'Saved', 'Remnant'] }, // Cross/Spiritual
            { name: 'Status', symbol: '✪', rankNames: ['Newbie', 'Trainee', 'Associate', 'Professional', 'Leader', 'Director', 'Icon'] }, // Star/Prestige
            { name: 'Space', symbol: '□', rankNames: ['Messy', 'Tidier', 'Organized', 'Keystone', 'Curator', 'Homestead Creator', 'Zen Master'] }, // Box/Structure
            { name: 'Time', symbol: 'ϟ', rankNames: ['Lost', 'Planner', 'Productive', 'Efficient', 'Architect', 'Momentum', 'Master of Flow'] }, // Lightning/Speed
            { name: 'World', symbol: '△', rankNames: ['Homebody', 'Traveler', 'Adventurer', 'Explorer', 'Trailblazer', 'World Citizen', 'Odyssey'] }, // Mountain/Triangle
            { name: 'Creative', symbol: '~', rankNames: ['Doodler', 'Penciller', 'Designer', 'Visionary', 'Auteur', 'Genius', 'Muse'] }, // Tilde/Wave/Flow
            { name: 'Tech', symbol: '⟳', rankNames: ['User', 'Tinkerer', 'Coder', 'Engineer', 'Architect', 'Innovator', 'Deus Ex Machina'] } // Cycle/Gear
        ];

        // --- PRE-GENERATED TIPS (72 sets: [Skill Index][Starting Rank Index (0-5)]) ---
        // Initialized with defaults, will be overwritten by loaded data
        let initialSkillTips = [
            // 0: Body
            [
                // Rank 0 (Newbie) -> Rank 1 (Apprentice)
                `**Current Analysis:** You are starting fresh. The foundation of a strong 'Body' score is consistency.
- **Tip 1:** Commit to a 10-minute walk or bodyweight routine daily, focusing on form.
- **Tip 2:** Replace one sugary drink with water every day. Hydration is key!
- **Tip 3:** Track your sleep and aim for a consistent bedtime, even on weekends.
- **Next Rank Expectation:** An **Apprentice** demonstrates consistency in basic physical health routines and can perform light, sustained physical activity without excessive strain.`,
                // Rank 1 (Apprentice) -> Rank 2 (Journeyman)
                `**Current Analysis:** You've built a base! Now focus on intensity and structure.
- **Tip 1:** Add 3 structured strength training sessions/week (30 min each, e.g., using dumbbells or resistance).
- **Tip 2:** Aim to drink 3 liters of water daily and track it.
- **Tip 3:** Incorporate dynamic stretching or a light yoga session 3 times a week.
- **Next Rank Expectation:** A **Journeyman** maintains consistent exercise, shows improvement in strength and stamina, and has improved daily energy levels.`,
                // Rank 2 (Journeyman) -> Rank 3 (Expert)
                `**Current Analysis:** Time to optimize and achieve measurable goals.
- **Tip 1:** Establish a full workout routine (4x/week) targeting all major muscle groups.
- **Tip 2:** Track your macros/nutrition for two weeks to identify areas for dietary improvement.
- **Tip 3:** Aim to achieve a benchmark fitness goal (e.g., run a 5K, complete 20 push-ups).
- **Next Rank Expectation:** An **Expert** has a disciplined health regimen, maintains good physical conditioning, and has accomplished specific fitness milestones.`,
                // Rank 3 (Expert) -> Rank 4 (Master)
                `**Current Analysis:** Your physical condition is strong; refine performance and recovery.
- **Tip 1:** Train for an endurance or power event (e.g., half-marathon, powerlifting meet) with a dedicated coach or program.
- **Tip 2:** Use a wearable device to optimize sleep metrics (aim for consistent deep/REM cycles).
- **Tip 3:** Practice advanced recovery techniques (e.g., cold exposure, foam rolling, active rest).
- **Next Rank Expectation:** A **Master** exhibits high-level, specialized physical conditioning and understands the science of recovery and performance optimization.`,
                // Rank 4 (Master) -> Rank 5 (Grandmaster)
                `**Current Analysis:** You are a high-level performer; now focus on holistic, long-term maintenance and teaching.
- **Tip 1:** Develop a personalized training plan that integrates physical, mental, and nutritional goals.
- **Tip 2:** Maintain peak health metrics (e.g., blood pressure, resting heart rate) for 6 consecutive months.
- **Tip 3:** Mentor three beginners in their fitness journey, sharing your knowledge and routine.
- **Next Rank Expectation:** A **Grandmaster** is an elite performer, consistently maintaining exceptional health, and serving as a knowledgeable role model for others.`,
                // Rank 5 (Grandmaster) -> Rank 6 (Legend)
                `**Current Analysis:** Legend status is reserved for those who redefine performance.
- **Tip 1:** Achieve a personal best or competitive feat in your chosen discipline that garners external recognition.
- **Tip 2:** Maintain optimal body composition and energy levels through seasonal changes.
- **Tip 3:** Integrate advanced bio-feedback tools (if available) to fine-tune your performance at a cellular level.
- **Next Rank Expectation:** A **Legend** has reached a recognized, elite physical status and is seen as an inspiration in their field.`,
            ],
            // 1: Mind
            [
                // Rank 0 (Newbie) -> Rank 1 (Learner)
                `**Current Analysis:** Your mind is an open book, ready to absorb knowledge.
- **Tip 1:** Spend 15 minutes daily reading non-fiction in a topic you want to master.
- **Tip 2:** Use a flashcard app to learn 5 new concepts or words each week.
- **Tip 3:** Teach someone else a small piece of information you recently learned to solidify it.
- **Next Rank Expectation:** A **Learner** actively seeks and retains new information, showing discipline in study habits and curiosity.`,
                // Rank 1 (Learner) -> Rank 2 (Scholar)
                `**Current Analysis:** Shift from casual reading to deep, structured learning.
- **Tip 1:** Read and summarize 1 non-fiction book per month on a core subject.
- **Tip 2:** Start journaling or writing long-form thought exercises 3 times a week.
- **Tip 3:** Learn a basic mental model (e.g., Occam's Razor, Compounding) and apply it to a real-life situation.
- **Next Rank Expectation:** A **Scholar** demonstrates the ability to consume complex information and utilize foundational cognitive tools.`,
                // Rank 2 (Scholar) -> Rank 3 (Thinker)
                `**Current Analysis:** You can handle complexity; focus on critical application.
- **Tip 1:** Dedicate 10 hours to deep-dive research into a complex, challenging topic outside your field.
- **Tip 2:** Start learning the basics of a new language (target 50 core words/phrases).
- **Tip 3:** Consistently solve complex logical puzzles (e.g., advanced Sudoku, logic grid problems).
- **Next Rank Expectation:** A **Thinker** is adept at synthesizing disparate information and applying rigorous logic to problem-solving.`,
                // Rank 3 (Thinker) -> Rank 4 (Sage)
                `**Current Analysis:** You're ready to master conceptual frameworks.
- **Tip 1:** Master three advanced mental models (e.g., First Principles, Inversion, Circle of Competence) and document their use.
- **Tip 2:** Finish a challenging, college-level online course or certification.
- **Tip 3:** Engage in formal, structured debates on complex philosophical or technical topics.
- **Next Rank Expectation:** A **Sage** demonstrates a deep understanding of multiple domains and can use advanced frameworks to analyze situations.`,
                // Rank 4 (Sage) -> Rank 5 (Guru)
                `**Current Analysis:** Your knowledge is profound; now create and communicate.
- **Tip 1:** Write and publish long-form analysis (e.g., an essay, blog series) that contributes original thought to a field.
- **Tip 2:** Develop a novel mental framework or process for solving a specific type of problem.
- **Tip 3:** Establish yourself as a go-to subject matter expert in one niche area among your peers.
- **Next Rank Expectation:** A **Guru** is a recognized source of deep wisdom and actively contributes new ideas and insights to the collective knowledge base.`,
                // Rank 5 (Guru) -> Rank 6 (Oracle)
                `**Current Analysis:** Oracle status is about prescience and mastery.
- **Tip 1:** Mentor experts in your field, guiding their thought processes and problem-solving.
- **Tip 2:** Tackle an unsolved problem or paradox within a domain and develop a credible working theory.
- **Tip 3:** Consistently demonstrate exceptional cognitive agility, solving novel problems under pressure.
- **Next Rank Expectation:** An **Oracle** possesses knowledge and insight that borders on foresight, significantly advancing understanding in their domains.`,
            ],
            // 2: Heart
            [
                // Rank 0 (Newbie) -> Rank 1 (Helper)
                `**Current Analysis:** You are ready to build genuine connections with others.
- **Tip 1:** Practice active listening. When someone talks, focus only on their words for two minutes.
- **Tip 2:** Send one genuine, thoughtful compliment or thank-you text this week.
- **Tip 3:** Volunteer 2 hours this month at a local charity or community event.
- **Next Rank Expectation:** A **Helper** reliably offers support to those close to them and consistently contributes positively to a group setting.`,
                // Rank 1 (Helper) -> Rank 2 (Friend)
                `**Current Analysis:** Expand your relational depth and influence.
- **Tip 1:** Initiate 3 new, genuine conversations with acquaintances or strangers weekly.
- **Tip 2:** Successfully navigate and handle a difficult conversation with a peer or family member with grace.
- **Tip 3:** Mediate a small conflict between two parties without taking sides.
- **Next Rank Expectation:** A **Friend** is a trustworthy person who effectively communicates and handles minor relational friction with maturity.`,
                // Rank 2 (Friend) -> Rank 3 (Connector)
                `**Current Analysis:** Time to focus on leadership through emotional intelligence.
- **Tip 1:** Consistently lead small group discussions or meetings, ensuring all voices are heard.
- **Tip 2:** Teach a soft skill (e.g., how to give effective feedback) to a group.
- **Tip 3:** Actively seek out and build a new connection with a person from a significantly different background.
- **Next Rank Expectation:** A **Connector** actively bridges different groups, understands diverse perspectives, and facilitates positive group dynamics.`,
                // Rank 3 (Connector) -> Rank 4 (Mentor)
                `**Current Analysis:** Your empathy is high; use it to empower others.
- **Tip 1:** Mentor three individuals for six or more months, focusing on their personal or professional growth.
- **Tip 2:** Successfully resolve a major organizational or family conflict through skilled communication.
- **Tip 3:** Practice a consistent, daily empathy exercise (e.g., journaling from another person's perspective).
- **Next Rank Expectation:** A **Mentor** demonstrates sustained emotional leadership and successfully guides multiple people toward greater self-awareness and success.`,
                // Rank 4 (Mentor) -> Rank 5 (Community Lead)
                `**Current Analysis:** Leverage your relational capital for large-scale impact.
- **Tip 1:** Lead a successful community initiative or large-scale volunteer project.
- **Tip 2:** Write a compelling policy or vision document for a team or group that genuinely inspires action.
- **Tip 3:** Intentionally build and maintain a large, diverse network characterized by high trust.
- **Next Rank Expectation:** A **Community Lead** organizes and inspires large groups, possessing significant social and emotional influence.`,
                // Rank 5 (Community Lead) -> Rank 6 (Empath)
                `**Current Analysis:** Empath status is deep, intuitive connection and influence.
- **Tip 1:** Become a unifying figure in a large, divided organization or community.
- **Tip 2:** Demonstrate profound emotional intelligence and stability under extreme stress or crisis.
- **Tip 3:** Inspire significant, lasting behavioral or social change through principled influence.
- **Next Rank Expectation:** An **Empath** possesses intuitive emotional foresight and uses it to achieve extraordinary collective alignment and well-being.`,
            ],
            // 3: Hand
            [
                // Rank 0 (Newbie) -> Rank 1 (Tinkerer)
                `**Current Analysis:** You have the potential for creation but need to start the practice.
- **Tip 1:** Start a small, defined project (e.g., assemble a piece of IKEA furniture, fix a leaky faucet).
- **Tip 2:** Dedicate one hour this week to learn a new tool (digital or physical).
- **Tip 3:** Organize your workspace to minimize distraction and maximize flow.
- **Next Rank Expectation:** A **Tinkerer** is comfortable using basic tools and can successfully complete simple, functional projects using their hands.`,
                // Rank 1 (Tinkerer) -> Rank 2 (Builder)
                `**Current Analysis:** Move from basic repair to active construction.
- **Tip 1:** Complete three complex DIY projects (e.g., basic electronics, woodworking shelf, small code script).
- **Tip 2:** Practice deliberate, focused skill improvement (e.g., mastering soldering, complex knot tying) for 10 hours.
- **Tip 3:** Document the process and tools used for all projects in a dedicated log.
- **Next Rank Expectation:** A **Builder** can follow complex instructions, create multi-stage functional items, and demonstrate improved dexterity.`,
                // Rank 2 (Builder) -> Rank 3 (Creator)
                `**Current Analysis:** Apply your skills to original concepts.
- **Tip 1:** Design and build a unique, functional item (hardware or software) that solves a personal problem.
- **Tip 2:** Master one professional-grade hand skill (e.g., a software library, a power tool, a cooking technique).
- **Tip 3:** Successfully teach a beginner how to complete a Builder-level task.
- **Next Rank Expectation:** A **Creator** demonstrates the ability to innovate, design from scratch, and execute projects with professional polish.`,
                // Rank 3 (Creator) -> Rank 4 (Artisan)
                `**Current Analysis:** Focus on high-quality execution and refinement.
- **Tip 1:** Complete a high-complexity, multi-stage project with exceptional attention to detail.
- **Tip 2:** Innovate or significantly improve a specific process or tool you commonly use.
- **Tip 3:** Contribute a functional piece of code or design to an open-source hardware or software project.
- **Next Rank Expectation:** An **Artisan** produces work of enduring quality and demonstrates a mastery of complex techniques and optimization.`,
                // Rank 4 (Artisan) -> Rank 5 (Inventor)
                `**Current Analysis:** Your skills are now commercial and influential.
- **Tip 1:** Start a small business or shop based on your hand skill and sell 10 original pieces/services.
- **Tip 2:** Create a lasting, recognized piece of work (e.g., a publicly used application, a permanent installation).
- **Tip 3:** Teach advanced workshops or courses to Artisans/Creators.
- **Next Rank Expectation:** An **Inventor** leverages their skill to create economic value or public contribution, demonstrating commercial viability and high-level instruction capability.`,
                // Rank 5 (Inventor) -> Rank 6 (Polymath)
                `**Current Analysis:** Polymath status requires generational excellence.
- **Tip 1:** Redefine industry standards with a novel craftsmanship or technical technique that is adopted by others.
- **Tip 2:** Achieve legendary status or critical acclaim in a specialized craft or technical domain.
- **Tip 3:** Integrate skills from 3+ domains (e.g., combining Tech, Creative, and Hand) to solve a cross-disciplinary problem.
- **Next Rank Expectation:** A **Polymath** is a master of many disciplines whose output sets new benchmarks for quality and innovation.`,
            ],
            // 4: Finance
            [
                // Rank 0 (Newbie) -> Rank 1 (Earner)
                `**Current Analysis:** Financial stability begins with awareness and control.
- **Tip 1:** Download a budgeting app (or use a spreadsheet) and track every dollar spent for one month.
- **Tip 2:** Identify one recurring, non-essential monthly expense to cut or reduce.
- **Tip 3:** Set a measurable short-term savings goal (e.g., $100 emergency fund).
- **Next Rank Expectation:** An **Earner** is fully aware of their income and expenses and has established a system for tracking their money.`,
                // Rank 1 (Earner) -> Rank 2 (Saver)
                `**Current Analysis:** Awareness leads to intentional saving and debt reduction.
- **Tip 1:** Create a detailed monthly budget that allocates funds before you spend them.
- **Tip 2:** Consistently save 10% or more of your income for six consecutive months.
- **Tip 3:** Create a plan to pay off your highest-interest debt (excluding mortgage) and stick to it.
- **Next Rank Expectation:** A **Saver** demonstrates disciplined budgeting, debt management, and reliable savings habits.`,
                // Rank 2 (Saver) -> Rank 3 (Investor)
                `**Current Analysis:** Your foundation is solid; start making your money work for you.
- **Tip 1:** Begin maxing out tax-advantaged retirement contributions (e.g., IRA, 401k match) to the maximum affordable level.
- **Tip 2:** Invest in a diversified, low-cost index fund and commit to weekly/monthly contributions.
- **Tip 3:** Create and track your net worth calculation monthly.
- **Next Rank Expectation:** An **Investor** actively utilizes investment vehicles for wealth building and understands the basic principles of compounding and diversification.`,
                // Rank 3 (Investor) -> Rank 4 (Financier)
                `**Current Analysis:** Shift focus from saving to strategic asset growth.
- **Tip 1:** Build or optimize at least three different income streams (active and passive).
- **Tip 2:** Actively manage a complex investment portfolio beyond simple index funds (e.g., real estate, individual stocks, bonds).
- **Tip 3:** Consult with a professional or dedicate 10 hours to optimizing your tax strategy legally.
- **Next Rank Expectation:** A **Financier** successfully manages complex income streams and assets, demonstrating proficiency in risk management and tax efficiency.`,
                // Rank 4 (Financier) -> Rank 5 (Tycoon)
                `**Current Analysis:** Your goals are shifting toward independence and scale.
- **Tip 1:** Achieve specific Financial Independence (FI) metrics (e.g., your net worth covers 10 years of living expenses).
- **Tip 2:** Manage investment portfolios or financial projects for others (e.g., a family trust, a small fund).
- **Tip 3:** Perform advanced financial modeling (e.g., projecting long-term portfolio returns, modeling business valuations).
- **Next Rank Expectation:** A **Tycoon** has reached a high level of personal financial security and uses advanced financial skills for large-scale management and modeling.`,
                // Rank 5 (Tycoon) -> Rank 6 (Croesus)
                `**Current Analysis:** Croesus status means wealth and influence beyond measure.
- **Tip 1:** Achieve generational wealth status, securing financial futures for multiple generations.
- **Tip 2:** Influence financial policy or market trends through your investments or expertise.
- **Tip 3:** Demonstrate profound fiscal security and resilience against major economic downturns.
- **Next Rank Expectation:** A **Croesus** is a figure of immense financial power and stability, whose wealth has broad, lasting influence.`,
            ],
            // 5: Soul
            [
                // Rank 0 (Damned) -> Rank 1 (Saved)
                `**Current Analysis:** Inner growth requires intentional reflection and routine.
- **Tip 1:** Practice 5 minutes of mindful meditation or deep breathing first thing in the morning.
- **Tip 2:** Keep a journal and write down one thing you are grateful for each day.
- **Tip 3:** Spend 1 hour this week in nature, fully disconnected from screens.
- **Next Rank Expectation:** A **Saved** soul has a consistent, daily practice of reflection or spirituality that provides a sense of peace and direction.`,
                // Rank 1 (Saved) -> Rank 2 (Saint/Sinner) (Note: We'll stick to 'Saved' as the next rank name from here)
                `**Current Analysis:** Your routine is established; now deepen your awareness.
- **Tip 1:** Increase your focused meditation practice to 15 minutes daily.
- **Tip 2:** Identify your three core personal values and write down how they conflict with your recent actions.
- **Tip 3:** Practice value-aligned decision-making for one week, logging the outcome.
- **Next Rank Expectation:** A **Saved** soul (Rank 2) has a deeper understanding of personal values and can use them to guide daily actions.`,
                // Rank 2 (Saved) -> Rank 3 (Saved)
                `**Current Analysis:** Explore complex inner states and philosophical questions.
- **Tip 1:** Engage in three deep philosophical or spiritual discussions with people of differing viewpoints.
- **Tip 2:** Practice forgiveness or "letting go" regarding a past grievance through journaling or ritual.
- **Tip 3:** Complete a challenging, multi-day retreat (e.g., digital detox, silent retreat).
- **Next Rank Expectation:** A **Saved** soul (Rank 3) confronts internal and external challenges with spiritual resilience and an expanded worldview.`,
                // Rank 3 (Saved) -> Rank 4 (Saved)
                `**Current Analysis:** True mastery is integration under pressure.
- **Tip 1:** Consistently live by your core values, even when it involves significant personal cost or friction.
- **Tip 2:** Mentor three others on finding inner peace or establishing their spiritual routines.
- **Tip 3:** Master emotional regulation techniques, remaining centered during high-stress situations.
- **Next Rank Expectation:** A **Saved** soul (Rank 4) is a beacon of calm, living with profound integrity and influencing the spiritual health of others.`,
                // Rank 4 (Saved) -> Rank 5 (Saved)
                `**Current Analysis:** Time for self-definition and profound acceptance.
- **Tip 1:** Write a comprehensive personal manifesto or philosophy of life (2,000+ words).
- **Tip 2:** Achieve deep inner peace and acceptance of things you cannot change, even in challenging times.
- **Tip 3:** Demonstrate radical self-acceptance, celebrating your flaws as integrated parts of your whole self.
- **Next Rank Expectation:** A **Saved** soul (Rank 5) has a fully realized and authentic inner life, characterized by deep personal acceptance and clarity.`,
                // Rank 5 (Saved) -> Rank 6 (Remnant)
                `**Current Analysis:** Remnant status implies transcending the ordinary limitations of self.
- **Tip 1:** Consistently operate in a state of high 'flow' or intuitive connection with the present moment.
- **Tip 2:** Serve as a spiritual or philosophical beacon for a wide community or organization.
- **Tip 3:** Successfully transcend a major, long-standing personal fear or anxiety through intentional practice.
- **Next Rank Expectation:** A **Remnant** is a rare individual whose spiritual or philosophical mastery offers deep wisdom and guidance to the world.`,
            ],
            // 6: Status
            [
                // Rank 0 (Newbie) -> Rank 1 (Trainee)
                `**Current Analysis:** Building professional and social status requires purposeful effort.
- **Tip 1:** Update your professional profile (e.g., LinkedIn) with a clear summary of your goals.
- **Tip 2:** Identify three skills required for your ideal job or role and find a free online course to begin.
- **Tip 3:** Attend one professional or industry event (even virtual) this month.
- **Next Rank Expectation:** A **Trainee** has a clear vision of their career path and has started acquiring fundamental skills and networking contacts.`,
                // Rank 1 (Trainee) -> Rank 2 (Associate)
                `**Current Analysis:** Translate your planning into tangible professional steps.
- **Tip 1:** Complete identified training, certifications, or a foundational technical project.
- **Tip 2:** Consistently network (target 2 new relevant professional contacts per week).
- **Tip 3:** Successfully lead a small, clearly defined project or task within a team setting.
- **Next Rank Expectation:** An **Associate** is a reliable team member who can independently execute tasks and is actively expanding their professional circle.`,
                // Rank 2 (Associate) -> Rank 3 (Professional)
                `**Current Analysis:** Time to focus on high-visibility contribution and reliability.
- **Tip 1:** Secure a promotion or formal role increase based on measurable performance.
- **Tip 2:** Consistently deliver high-visibility, high-stakes work with minimal error.
- **Tip 3:** Successfully mentor three junior colleagues on specific skills.
- **Next Rank Expectation:** A **Professional** is a recognized expert in their immediate function, trusted with significant responsibility, and contributes to the growth of others.`,
                // Rank 3 (Professional) -> Rank 4 (Leader)
                `**Current Analysis:** Your influence must expand beyond your immediate projects.
- **Tip 1:** Become a recognized thought leader in a niche—write articles or give talks on your expertise.
- **Tip 2:** Manage a team, project, or large, multi-faceted initiative from start to finish.
- **Tip 3:** Give a major, well-received presentation or keynote at an industry event.
- **Next Rank Expectation:** A **Leader** directs the work of others, shapes team strategy, and has growing external recognition in their field.`,
                // Rank 4 (Leader) -> Rank 5 (Director)
                `**Current Analysis:** Achieve strategic influence and systems change.
- **Tip 1:** Secure a seat on an industry board, standards committee, or high-level organizational task force.
- **Tip 2:** Achieve an executive-level position/title that involves setting organizational strategy.
- **Tip 3:** Mentor emerging leaders and high-performers, developing the next generation of talent.
- **Next Rank Expectation:** A **Director** wields strategic, organizational influence and is responsible for long-term vision and talent development.`,
                // Rank 5 (Director) -> Rank 6 (Icon)
                `**Current Analysis:** Icon status is reserved for those who set the standard.
- **Tip 1:** Become the definitive, recognized public figure or authority in your profession or industry.
- **Tip 2:** Set the standard for leadership or excellence that is widely emulated across organizations.
- **Tip 3:** Create a lasting legacy (e.g., founding a major organization, implementing a globally recognized framework).
- **Next Rank Expectation:** An **Icon** is a figure whose work, influence, and reputation are globally recognized and highly authoritative.`,
            ],
            // 7: Space
            [
                // Rank 0 (Messy) -> Rank 1 (Tidier)
                `**Current Analysis:** Your environment reflects your state of mind. Start small.
- **Tip 1:** Declutter your desk or bedside table completely and keep it clean for 7 days.
- **Tip 2:** Implement the "one-in, one-out" rule for a specific category (e.g., clothes, books).
- **Tip 3:** Create a designated, permanent "home" for five items that are often misplaced.
- **Next Rank Expectation:** A **Tidier** has established basic cleaning and organizational habits that prevent their primary living and work areas from descending into chaos.`,
                // Rank 1 (Tidier) -> Rank 2 (Organized)
                `**Current Analysis:** Scale your efforts to major areas of your life.
- **Tip 1:** Completely organize one major area of clutter (e.g., closet, garage, digital downloads folder).
- **Tip 2:** Establish a 15-minute daily "reset" or cleaning routine and stick to it for one month.
- **Tip 3:** Automate recurring paperwork and bill payments to clear physical clutter.
- **Next Rank Expectation:** An **Organized** person successfully manages large areas of their environment and has automated routines to prevent clutter buildup.`,
                // Rank 2 (Organized) -> Rank 3 (Keystone)
                `**Current Analysis:** Focus on systematic management and long-term maintenance.
- **Tip 1:** Implement a robust filing or digital cloud system for all documents and photos.
- **Tip 2:** Maintain overall cleanliness and organization in your primary spaces for three consecutive months.
- **Tip 3:** Optimize the "flow" of a major space, making high-use items easily accessible.
- **Next Rank Expectation:** A **Keystone** consistently maintains organized physical and digital environments through robust, proven systems.`,
                // Rank 3 (Keystone) -> Rank 4 (Curator)
                `**Current Analysis:** Your environment is perfected; now apply your expertise externally.
- **Tip 1:** Design and execute a major space renovation or organization project (e.g., kitchen remodel, total office rehaul).
- **Tip 2:** Consult with or help three others organize a major area of their life.
- **Tip 3:** Actively minimize possessions or digital files, practicing intentional minimalism.
- **Next Rank Expectation:** A **Curator** designs highly functional environments for themselves and others, demonstrating strategic minimalism.`,
                // Rank 4 (Curator) -> Rank 5 (Homestead Creator)
                `**Current Analysis:** Systematize organization across all domains.
- **Tip 1:** Master digital organization (email inbox zero, file naming conventions, cloud structure) and maintain it for 6 months.
- **Tip 2:** Create a high-efficiency environment that maximizes productivity and minimizes mental friction.
- **Tip 3:** Teach advanced organizational and spatial efficiency methods to groups.
- **Next Rank Expectation:** A **Homestead Creator** has designed and maintains a near-perfectly efficient living and working environment, influencing others through their methods.`,
                // Rank 5 (Homestead Creator) -> Rank 6 (Zen Master)
                `**Current Analysis:** Zen Master status is total, effortless environmental harmony.
- **Tip 1:** Achieve and maintain a state of *effortless* organization across all physical and digital domains.
- **Tip 2:** Design a space (or digital interface) that is globally recognized for its functional perfection.
- **Tip 3:** Demonstrate complete inner peace and mental clarity derived directly from your environment.
- **Next Rank Expectation:** A **Zen Master** has achieved profound harmony between their inner and outer worlds through total spatial mastery.`,
            ],
            // 8: Time
            [
                // Rank 0 (Lost) -> Rank 1 (Planner)
                `**Current Analysis:** Time mastery starts with knowing where your hours go.
- **Tip 1:** Plan your three most important tasks for the next day before you go to bed tonight.
- **Tip 2:** Use a timer for work sessions (e.g., 25 minutes focused work, 5 minutes break).
- **Tip 3:** Identify your biggest time sink (e.g., social media) and set a strict daily limit for it.
- **Next Rank Expectation:** A **Planner** consistently uses a calendar or tool to structure their day and week, reducing time wasted on indecision.`,
                // Rank 1 (Planner) -> Rank 2 (Productive)
                `**Current Analysis:** Increase your efficiency and protect your focus.
- **Tip 1:** Implement task batching (e.g., only check email at 10 AM and 3 PM).
- **Tip 2:** Learn and apply three effective delegation or outsourcing strategies for low-value tasks.
- **Tip 3:** Track your actual time usage (e.g., using a time tracking app) for one full week.
- **Next Rank Expectation:** A **Productive** person is conscious of where their time goes, manages distraction, and increases their effective output hourly.`,
                // Rank 2 (Productive) -> Rank 3 (Efficient)
                `**Current Analysis:** Systematize your entire workflow for speed and reliability.
- **Tip 1:** Master one specific productivity system (e.g., Getting Things Done, Kanban) and stick to it for two months.
- **Tip 2:** Consistently meet or beat deadlines on complex projects for a full quarter.
- **Tip 3:** Eliminate one major, recurring time-waster completely from your weekly schedule.
- **Next Rank Expectation:** An **Efficient** person is highly systematic, able to handle complex projects, and reliable in meeting all commitments.`,
                // Rank 3 (Efficient) -> Rank 4 (Architect)
                `**Current Analysis:** Move from task management to long-term strategic time design.
- **Tip 1:** Define and protect deep work blocks (4+ hours) every week for high-value creation.
- **Tip 2:** Reliably forecast project completion times with less than 10% error rate.
- **Tip 3:** Consistently execute a detailed weekly review, refining your systems and eliminating bottlenecks.
- **Next Rank Expectation:** An **Architect** designs their work and life processes for maximum strategic output and maintains high predictability in their commitments.`,
                // Rank 4 (Architect) -> Rank 5 (Momentum)
                `**Current Analysis:** Your time system is near-perfect; now apply it to multi-year goals.
- **Tip 1:** Successfully manage simultaneous, multi-year projects effectively.
- **Tip 2:** Implement advanced automation and efficiency tools (e.g., custom scripts, AI integration) to remove administrative overhead.
- **Tip 3:** Mentor three high-performers on adopting your efficiency methodologies.
- **Next Rank Expectation:** A **Momentum** driver creates lasting forward progress in multiple domains and uses cutting-edge tools to maximize leverage.`,
                // Rank 5 (Momentum) -> Rank 6 (Master of Flow)
                `**Current Analysis:** Master of Flow status is total control and transcendence of stress.
- **Tip 1:** Consistently operate in a state of high flow and minimal stress, even during intense workloads.
- **Tip 2:** Successfully optimize the processes and time management for an entire team or company.
- **Tip 3:** Write a definitive guide or philosophy on time management and productivity.
- **Next Rank Expectation:** A **Master of Flow** operates at the peak of human efficiency, achieving massive results with visible ease and setting industry standards.`,
            ],
            // 9: World
            [
                // Rank 0 (Homebody) -> Rank 1 (Traveler)
                `**Current Analysis:** Your comfort zone is safe, but the world awaits exploration.
- **Tip 1:** Dedicate one day this month to visit a neighborhood or town near you that you've never been to.
- **Tip 2:** Learn three basic phrases in a foreign language that interests you.
- **Tip 3:** Research and bookmark three locations you aspire to visit in the next five years.
- **Next Rank Expectation:** A **Traveler** is comfortable navigating unfamiliar local environments and actively seeks out cultural or geographical knowledge.`,
                // Rank 1 (Traveler) -> Rank 2 (Adventurer)
                `**Current Analysis:** Increase your independence and cultural immersion.
- **Tip 1:** Travel solo for a weekend trip to a new city or nature area.
- **Tip 2:** Learn 100 useful phrases in a new language.
- **Tip 3:** Try five different ethnic cuisines you've never had before.
- **Next Rank Expectation:** An **Adventurer** demonstrates independence in unfamiliar settings and actively engages with diverse global culture.`,
                // Rank 2 (Adventurer) -> Rank 3 (Explorer)
                `**Current Analysis:** Time to embrace the complex logistics of global travel.
- **Tip 1:** Travel to a foreign country independently and manage all logistics (flights, accommodation, transit).
- **Tip 2:** Achieve basic conversational fluency in one foreign language (enough to order food and ask for directions).
- **Tip 3:** Research and summarize two complex global issues (e.g., climate change policy, geopolitical conflicts).
- **Next Rank Expectation:** An **Explorer** is fully independent in international travel and maintains a serious awareness of global current events.`,
                // Rank 3 (Explorer) -> Rank 4 (Trailblazer)
                `**Current Analysis:** Deepen your immersion and cultural competence.
- **Tip 1:** Live abroad for three or more months, integrating into the local community.
- **Tip 2:** Achieve deep cultural competence (understanding unwritten social rules) in two different countries.
- **Tip 3:** Teach native customs or language basics to others in a respectful manner.
- **Next Rank Expectation:** A **Trailblazer** has achieved profound cultural adaptability and can comfortably live and work in diverse international settings.`,
                // Rank 4 (Trailblazer) -> Rank 5 (World Citizen)
                `**Current Analysis:** Your global understanding is a resource for others.
- **Tip 1:** Master three or more languages to a high proficiency (B2 level or above).
- **Tip 2:** Publish a travelogue, cultural insights, or guide that is widely recognized for its depth.
- **Tip 3:** Consistently navigate complex global logistics (e.g., multiple visas, residency permits, international finance).
- **Next Rank Expectation:** A **World Citizen** operates seamlessly across multiple countries and cultures, possessing linguistic and logistical global mastery.`,
                // Rank 5 (World Citizen) -> Rank 6 (Odyssey)
                `**Current Analysis:** Odyssey status is historical global influence.
- **Tip 1:** Become a recognized diplomat, cultural bridge, or expert on global affairs for an organization or government.
- **Tip 2:** Demonstrate profound global awareness and influence by successfully predicting or shaping international trends.
- **Tip 3:** Successfully complete a high-stakes, multi-country mission or journey.
- **Next Rank Expectation:** An **Odyssey** is a legendary figure of global travel and influence, whose wisdom and experience are highly valued internationally.`,
            ],
            // 10: Creative
            [
                // Rank 0 (Doodler) -> Rank 1 (Penciller)
                `**Current Analysis:** Creativity is a muscle that needs exercise, not inspiration.
- **Tip 1:** Commit to 15 minutes of "free flow" drawing or writing every other day.
- **Tip 2:** Study the work of one creative person you admire and try to imitate their style once.
- **Tip 3:** Get an external critique on a piece of work you created this month (even if it's small).
- **Next Rank Expectation:** A **Penciller** has a dedicated creative output habit and produces work regularly, even if it is still experimental.`,
                // Rank 1 (Penciller) -> Rank 2 (Designer)
                `**Current Analysis:** Define your style and expand your technical toolkit.
- **Tip 1:** Complete three finished, polished creative pieces (e.g., short story, small painting, design mock-up).
- **Tip 2:** Develop a unique personal style or voice that others can recognize.
- **Tip 3:** Learn one new creative medium or software (e.g., video editing, music production basics).
- **Next Rank Expectation:** A **Designer** produces polished work, has a distinct style, and commands tools across multiple creative forms.`,
                // Rank 2 (Designer) -> Rank 3 (Visionary)
                `**Current Analysis:** Increase the visibility and professionalism of your output.
- **Tip 1:** Consistently publish or share creative work on a public platform (weekly/monthly).
- **Tip 2:** Receive and successfully integrate professional feedback on a major piece.
- **Tip 3:** Learn the core principles of composition, design theory, or narrative structure.
- **Next Rank Expectation:** A **Visionary** creates aesthetically and structurally sound work that gains public attention and demonstrates technical competence.`,
                // Rank 3 (Visionary) -> Rank 4 (Auteur)
                `**Current Analysis:** Focus on large-scale, sustained creative projects.
- **Tip 1:** Complete a major creative project (e.g., a short film, a full album, a complete novel manuscript, a large-scale painting).
- **Tip 2:** Earn money (or receive significant non-monetary recognition) directly from your creative work.
- **Tip 3:** Successfully collaborate on a creative project with a team of three or more people.
- **Next Rank Expectation:** An **Auteur** completes significant, income-generating creative work and manages complex collaborations.`,
                // Rank 4 (Auteur) -> Rank 5 (Genius)
                `**Current Analysis:** Your creative influence must reshape the field.
- **Tip 1:** Become a recognized leader or innovator in a specific creative niche (e.g., a new style of digital art, a unique storytelling format).
- **Tip 2:** Teach advanced workshops or courses to Auteurs/Visionaries, passing on specialized knowledge.
- **Tip 3:** Mentor three emerging artists or creators, guiding their careers.
- **Next Rank Expectation:** A **Genius** is a highly influential master who innovates techniques and teaches the next generation of creative talent.`,
                // Rank 5 (Genius) -> Rank 6 (Muse)
                `**Current Analysis:** Muse status is reserved for those who inspire entire movements.
- **Tip 1:** Define a new style or genre that is adopted by the wider creative community.
- **Tip 2:** Achieve critical acclaim and legacy status for your body of work.
- **Tip 3:** Inspire a new generation of creators through the profundity of your vision and execution.
- **Next Rank Expectation:** A **Muse** is a generational talent whose creative output transcends its time and shapes the culture around it.`,
            ],
            // 11: Tech
            [
                // Rank 0 (User) -> Rank 1 (Tinkerer)
                `**Current Analysis:** You know how to use technology, now learn how it works.
- **Tip 1:** Learn one new keyboard shortcut every day for a week.
- **Tip 2:** Spend 30 minutes reading introductory material on how the internet or a specific app works.
- **Tip 3:** Back up your primary device's important files to an external drive or cloud service.
- **Next Rank Expectation:** A **Tinkerer** is capable of troubleshooting basic software and hardware issues and understands fundamental digital security practices.`,
                // Rank 1 (Tinkerer) -> Rank 2 (Coder)
                `**Current Analysis:** Move from usage to basic control and scripting.
- **Tip 1:** Master the basics of one scripting language (e.g., Python, Bash) or the fundamentals of HTML/CSS.
- **Tip 2:** Successfully troubleshoot three hardware or software issues on your own devices independently.
- **Tip 3:** Implement two-factor authentication (2FA) on all critical online accounts.
- **Next Rank Expectation:** A **Coder** understands basic programming concepts, can write small utility scripts, and actively practices digital security.`,
                // Rank 2 (Coder) -> Rank 3 (Engineer)
                `**Current Analysis:** Build functional and shareable technology.
- **Tip 1:** Build a simple, personal website or utility tool using code you wrote.
- **Tip 2:** Actively contribute code or documentation to a technical community or project.
- **Tip 3:** Automate one recurring, tedious task using your scripting skills.
- **Next Rank Expectation:** An **Engineer** designs and builds functional software solutions and actively participates in the technical ecosystem.`,
                // Rank 3 (Engineer) -> Rank 4 (Architect)
                `**Current Analysis:** Focus on complexity, structure, and foundational knowledge.
- **Tip 1:** Develop a complex, multi-feature application (e.g., a full-stack project).
- **Tip 2:** Master cloud fundamentals (e.g., setting up a server, using cloud storage) or a complex database technology.
- **Tip 3:** Understand and explain advanced security practices (e.g., encryption, phishing defense).
- **Next Rank Expectation:** An **Architect** designs robust, structured systems and understands the infrastructure and security principles necessary for complex technology.`,
                // Rank 4 (Architect) -> Rank 5 (Innovator)
                `**Current Analysis:** Your technical work must achieve scale and influence.
- **Tip 1:** Architect and deploy a scalable system or solution (e.g., a microservice, a high-traffic website infrastructure).
- **Tip 2:** Successfully lead a development or technical implementation team for a major project.
- **Tip 3:** Teach advanced technical concepts (e.g., data structures, system design) to other Engineers.
- **Next Rank Expectation:** An **Innovator** designs and leads the development of large-scale systems and mentors other high-level technical talent.`,
                // Rank 5 (Innovator) -> Rank 6 (Deus Ex Machina)
                `**Current Analysis:** Deus Ex Machina status is reserved for those who fundamentally redefine technology.
- **Tip 1:** Design a novel technological solution that fundamentally changes an existing process or field.
- **Tip 2:** Achieve industry-wide recognition as an expert or pioneer in a specific technical discipline.
- **Tip 3:** Build a system that operates with total resilience and minimal manual intervention.
- **Next Rank Expectation:** A **Deus Ex Machina** is a technical visionary whose work has profound, lasting impact on the world of technology.`,
            ]
        ];
        
        // --- CORE APPLICATION LOGIC ---
        let scores = Array(12).fill(0);
        let selectedIndex = -1; // -1 means no button is selected
        let pendingAssignments = null; // Stores the calculated points before application {skillName: points}
        // Use the comprehensive 2D array for tips
        let skillTips = initialSkillTips; 


        const gridContainer = document.getElementById('grid-container');
        const activityTextInput = document.getElementById('activity-text-input');
        const excludedSkillsInput = document.getElementById('excluded-skills-input');
        const manualPointsInput = document.getElementById('manual-points-input');
        const analyzeActivityButton = document.getElementById('analyze-activity-btn');
        const statusMessage = document.getElementById('status-message');
        
        // UI elements
        const recommendationOutput = document.getElementById('recommendation-output');
        const recommendationText = document.getElementById('recommendation-text');
        const recommendationEditor = document.getElementById('recommendation-editor');
        const applyRecommendationButton = document.getElementById('apply-recommendation-btn');
        const editTipsButton = document.getElementById('edit-tips-btn');
        const saveTipsButton = document.getElementById('save-tips-btn');
        const cancelEditButton = document.getElementById('cancel-edit-btn');
        const saveDataButton = document.getElementById('save-data-btn');


        // --- FIREBASE FUNCTIONS ---
        async function getDocRef() {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            // Private data path: /artifacts/{appId}/users/{userId}/skill_tracker_data/profile
            const docPath = `artifacts/${appId}/users/${userId}/skill_tracker_data/profile`;
            return doc(db, docPath);
        }
        
        async function saveData() {
            if (!isFirebaseReady) {
                console.warn("Firebase not ready. Save aborted.");
                statusMessage.textContent = "Cannot save: Database not initialized.";
                return;
            }
            
            const dataToSave = {
                scores: scores,
                skillTips: skillTips, // Saving the entire 2D array
                updatedAt: serverTimestamp() 
            };

            try {
                await setDoc(await getDocRef(), dataToSave);
                statusMessage.textContent = "Data saved successfully!";
            } catch (e) {
                console.error("Error saving data:", e);
                statusMessage.textContent = "Error saving data.";
            }
        }
        
        function startDataListener() {
            if (!isFirebaseReady) return;

            // Set debug log level to see internal Firebase logs
            setLogLevel('Debug');
            
            // onSnapshot attaches a listener that updates in real time
            onSnapshot(doc(db, `artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'}/users/${userId}/skill_tracker_data/profile`), (docSnap) => {
                if (docSnap.exists()) {
                    const loadedData = docSnap.data();
                    let updated = false;

                    // Load Scores
                    if (Array.isArray(loadedData.scores) && loadedData.scores.length === 12) {
                        scores = loadedData.scores;
                        scores.forEach((_, index) => updateButtonDisplay(index));
                        updated = true;
                    }

                    // Load Custom Tips
                    if (Array.isArray(loadedData.skillTips) && loadedData.skillTips.length === 12) {
                        const isValidStructure = loadedData.skillTips.every(row => Array.isArray(row) && row.length === 6);
                        if (isValidStructure) {
                            skillTips = loadedData.skillTips; 
                            updated = true;
                        }
                    }
                    
                    if (updated) {
                         // Update UI and status
                        statusMessage.textContent = `Data loaded for user ${userId.substring(0, 8)}...`;
                        // Ensure the currently selected button view is updated with potentially new score/tips
                        if (selectedIndex !== -1) {
                            selectButton(selectedIndex, gridContainer.querySelector(`[data-index="${selectedIndex}"]`));
                        }
                    }

                } else {
                    console.log("No existing profile found. Starting new. Saving default data...");
                    // Save the default data immediately so the listener has something to attach to
                    saveData();
                }
            }, (error) => {
                console.error("Error listening to data:", error);
                statusMessage.textContent = "Error loading data.";
            });
        }


        async function initFirebase() {
            try {
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

                if (!firebaseConfig.apiKey) {
                    console.error("Firebase configuration is missing. Data will not be saved.");
                    statusMessage.textContent = "Offline Mode: Cannot save data (Firebase config missing).";
                    return;
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // 1. Sign in
                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                
                userId = auth.currentUser.uid;
                isFirebaseReady = true;

                // 2. Start Listening
                startDataListener();

            } catch (e) {
                console.error("Firebase initialization failed:", e);
                statusMessage.textContent = "Error: Failed to initialize database. Data will not be saved.";
            }
        }
        
        // --- END FIREBASE FUNCTIONS ---


        // Helper to parse comma-separated list into a Set
        function parseSkillList(input) {
            return new Set(
                input.split(',')
                     .map(s => s.trim())
                     .filter(s => s.length > 0)
            );
        }

        // Helper to parse manual assignments (e.g., "Mind: 5, Heart: 3")
        function parseManualPoints(input) {
            const manualPoints = {};
            const parts = input.split(',').map(p => p.trim()).filter(p => p.length > 0);
            
            parts.forEach(part => {
                const match = part.match(/([^:]+):\s*(\d+)/);
                if (match) {
                    const skillName = match[1].trim();
                    const points = parseInt(match[2], 10);
                    // Points are capped at 100
                    manualPoints[skillName] = Math.min(100, Math.max(0, points)); 
                }
            });
            return manualPoints;
        }

        // Function to convert simple markdown (like **bold** and - list) to rough HTML
        function simpleMarkdownToHtml(markdownText) {
            if (!markdownText) return '';
            let html = markdownText
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold
                .replace(/^- (.*)/gm, '<li>$1</li>')              // List items
                .replace(/(\n)/g, '<br>');                        // Line breaks
            
            // Wrap list items in <ul> if list markers were found
            if (html.includes('<li>')) {
                html = html.replace(/<br><li>/g, '<li>'); // Clean up list breaks
                html = '<ul>' + html + '</ul>';
                // Remove leading <br> before <ul>
                html = html.replace(/^<br>/, '');
            }
            return html;
        }

        // Function to create the 12 buttons
        function createButtons() {
            for (let i = 0; i < 12; i++) {
                const button = document.createElement('button');
                button.className = 'score-button';
                button.setAttribute('data-index', i);
                // Attach event listener to select the button and display tips
                button.addEventListener('click', (e) => selectButton(i, e.currentTarget)); 
                gridContainer.appendChild(button);
                updateButtonDisplay(i); // Initialize display with skill name and rank
            }
        }
        
        // Function to handle button selection (now loads tips based on rank)
        function selectButton(index, buttonElement) { 
            const previousSelected = gridContainer.querySelector('.score-button.selected');
            if (previousSelected) {
                previousSelected.classList.remove('selected');
            }
            selectedIndex = index;
            buttonElement.classList.add('selected');
            
            const skill = SKILL_DATA[index];
            const { rankName: currentRankName, rankIndex } = getRank(scores[index], index);
            const nextRankIndex = Math.min(rankIndex + 1, skill.rankNames.length - 1);
            const nextRankName = skill.rankNames[nextRankIndex];

            // 1. Update status message
            statusMessage.textContent = `${skill.name} selected. Rank: ${currentRankName} (${scores[index]}/100)`;
            
            // 2. Clear any pending point assignments and hide point controls
            pendingAssignments = null;
            applyRecommendationButton.style.display = 'none'; 

            // 3. Display Tips/Max Rank Message
            recommendationOutput.style.display = 'block';
            recommendationEditor.style.display = 'none'; // Ensure editor is hidden
            recommendationText.style.display = 'block';  // Ensure text is visible
            
            // Hide save/cancel buttons
            saveTipsButton.style.display = 'none';
            cancelEditButton.style.display = 'none';

            if (rankIndex === skill.rankNames.length - 1) {
                recommendationText.innerHTML = `<strong>${skill.name} - MAX RANK ACHIEVED!</strong><p>You have reached the <strong>${currentRankName}</strong> level. There is no next rank to aim for.</p>`;
                editTipsButton.style.display = 'none'; // No tips to edit at max rank
                return;
            }

            // --- Load tips based on the current rankIndex (which is the starting transition index) ---
            const tipsLookupIndex = rankIndex; // 0 -> 1 uses index 0, 1 -> 2 uses index 1, etc.
            const rawTips = skillTips[index][tipsLookupIndex]; // 2D lookup [skillIndex][startingRank]
            const tipsHtml = simpleMarkdownToHtml(rawTips);

            recommendationText.innerHTML = `<strong>Guidance for ${skill.name} (${currentRankName} &rarr; ${nextRankName}):</strong><hr style="margin: 5px 0; border: none; border-top: 1px dashed #ccc;">` + tipsHtml;
            
            // Show edit button for tips
            editTipsButton.style.display = 'inline-block';
        }

        // Function to handle switching between read-only and edit modes
        function toggleTipEditMode(isEditing) {
            if (selectedIndex === -1) return;
            // Get current rank index to find the correct tip slot
            const { rankIndex } = getRank(scores[selectedIndex], selectedIndex);

            if (isEditing) {
                // Switch to edit mode
                recommendationText.style.display = 'none';
                recommendationEditor.style.display = 'block';
                // Load raw text using 2D index
                recommendationEditor.value = skillTips[selectedIndex][rankIndex]; 
                
                editTipsButton.style.display = 'none';
                applyRecommendationButton.style.display = 'none'; // Hide apply button if visible
                saveTipsButton.style.display = 'inline-block';
                cancelEditButton.style.display = 'inline-block';
                statusMessage.textContent = `Editing tips for ${SKILL_DATA[selectedIndex].name} (Rank ${rankIndex} transition).`;

            } else {
                // Switch back to view mode
                // Load saved raw text using 2D index
                const rawTips = skillTips[selectedIndex][rankIndex]; 
                const tipsHtml = simpleMarkdownToHtml(rawTips);

                recommendationEditor.style.display = 'none';
                recommendationText.style.display = 'block';
                
                // Re-render the display area
                const skill = SKILL_DATA[selectedIndex];
                const nextRankIndex = Math.min(rankIndex + 1, skill.rankNames.length - 1);
                const nextRankName = skill.rankNames[nextRankIndex];

                recommendationText.innerHTML = `<strong>Guidance for ${skill.name} (${skill.rankNames[rankIndex]} &rarr; ${nextRankName}):</strong><hr style="margin: 5px 0; border: none; border-top: 1px dashed #ccc;">` + tipsHtml;

                editTipsButton.style.display = 'inline-block';
                // Only show apply button if there is a pending assignment (which there won't be in tip mode)
                applyRecommendationButton.style.display = 'none'; 
                saveTipsButton.style.display = 'none';
                cancelEditButton.style.display = 'none';
                statusMessage.textContent = `${skill.name} selected. Rank: ${skill.rankNames[rankIndex]} (${scores[selectedIndex]}/100).`;
            }
        }

        // Function to save the manually edited tips
        async function saveEditedTips() {
            if (selectedIndex !== -1) {
                const { rankIndex } = getRank(scores[selectedIndex], selectedIndex);
                // Save to the specific rank transition slot
                skillTips[selectedIndex][rankIndex] = recommendationEditor.value;
                toggleTipEditMode(false); // Switch back to view mode
                await saveData(); // Save to database
            }
        }

        // Function to update a single button's display
        function updateButtonDisplay(index) {
            const button = gridContainer.querySelector(`[data-index="${index}"]`);
            if (button) {
                const skill = SKILL_DATA[index];
                const { rankName } = getRank(scores[index], index);
                
                // Display: Skill Name \n Symbol \n Rank Name \n Score/100
                button.innerHTML = `${skill.name}<br><span class="skill-symbol">${skill.symbol}</span><br>${rankName}<br>${scores[index]}/100`;
            }
        }

        // --- XP/SCORE THRESHOLD LOGIC (Non-linear progression) ---
        function getRank(score, skillIndex) {
            const ranks = SKILL_DATA[skillIndex].rankNames;
            let rankIndex = 0;
            
            // Non-linear, escalating thresholds:
            if (score >= 91) {
                rankIndex = 6; 
            } else if (score >= 71) {
                rankIndex = 5; 
            } else if (score >= 51) {
                rankIndex = 4; 
            } else if (score >= 31) {
                rankIndex = 3; 
            } else if (score >= 16) {
                rankIndex = 2; 
            } else if (score >= 6) {
                rankIndex = 1; 
            } else {
                rankIndex = 0; 
            }

            const rankName = ranks[rankIndex];
            return { rankName, rankIndex };
        }
        
        // --- REST OF THE CODE (UNCHANGED POINT ANALYSIS LOGIC) ---
        
        const RESPONSE_SCHEMA = {
            type: "ARRAY",
            description: "An array of skills and the points they should receive (0 if irrelevant).",
            items: {
                type: "OBJECT",
                properties: {
                    "skillName": { "type": "STRING", description: "Must exactly match one name from the list provided in the prompt." },
                    "pointsToAdd": { "type": "INTEGER", description: "Points to add, ranging from 0 to 10 based on the activity's intensity and duration." }
                },
                required: ["skillName", "pointsToAdd"]
            }
        };

        const SYSTEM_INSTRUCTION = `You are an RPG Skill Points Analyst. Your task is to analyze a user's real-life activity and assign point values (0-10) to only the specific skills requested, based on the activity's nature, intensity, and duration. Respond ONLY with a JSON array that maps points to the requested skills.`;


        async function fetchGeminiApi(payload, retries = 0) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                if (retries < 3) {
                    const delay = Math.pow(2, retries) * 1000;
                    // console.error(`API call failed. Retrying in ${delay}ms...`, error); // Hidden for production
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchGeminiApi(payload, retries + 1);
                } else {
                    throw new Error("API call failed after multiple retries.");
                }
            }
        }
        
        // --- FUNCTION: APPLY PENDING ASSIGNMENTS ---
        async function applyPendingAssignments() {
            if (!pendingAssignments) {
                statusMessage.textContent = "No recommendation to apply.";
                return;
            }

            let totalPointsAdded = 0;
            let updateSummary = "";
            const updatedIndices = [];

            // Iterate over the combined final assignments stored in pendingAssignments
            Object.keys(pendingAssignments).forEach(skillName => {
                const points = pendingAssignments[skillName];
                const skillIndex = SKILL_DATA.findIndex(s => s.name === skillName);
                
                // Only apply points if the calculated amount is positive
                if (skillIndex !== -1 && points > 0) {
                    const currentScore = scores[skillIndex];
                    let newScore = currentScore + points;
                    let clampedPoints = points;
                    
                    // Clamp to 100
                    if (newScore > 100) {
                        clampedPoints = 100 - currentScore;
                        newScore = 100;
                    }
                    
                    // Only update if points are actually added
                    if (clampedPoints > 0) {
                        scores[skillIndex] = newScore;
                        totalPointsAdded += clampedPoints;
                        updatedIndices.push(skillIndex);
                        updateSummary += `${SKILL_DATA[skillIndex].symbol} ${skillName} +${clampedPoints} | `;
                    }
                }
            });

            // Final Display Update
            updatedIndices.forEach(updateButtonDisplay);
            
            if (totalPointsAdded > 0) {
                statusMessage.textContent = `Applied! Total points added: ${totalPointsAdded}. (${updateSummary.trim()})`;
                await saveData(); // Save new scores to database
            } else {
                statusMessage.textContent = "No points were applied from the recommendation.";
            }

            // Clean up
            pendingAssignments = null;
            recommendationOutput.style.display = 'none';
            applyRecommendationButton.style.display = 'none'; // Hide the Apply button

            // Force selected skill status update (since score might have changed)
            if (selectedIndex !== -1) {
                selectButton(selectedIndex, gridContainer.querySelector(`[data-index="${selectedIndex}"]`));
            }
        }


        async function handleAnalyzeActivityClick() {
            const activityText = activityTextInput.value.trim();
            if (activityText.length < 10) {
                statusMessage.textContent = "Please enter a more detailed activity description.";
                return;
            }

            // Reset UI for new analysis
            analyzeActivityButton.disabled = true;
            recommendationOutput.style.display = 'none';
            applyRecommendationButton.style.display = 'none'; // Hide apply button initially
            editTipsButton.style.display = 'none';
            pendingAssignments = null;
            statusMessage.textContent = "Processing activity...";

            try {
                // 1. Process Manual Assignments and Exclusions
                const manualAssignments = parseManualPoints(manualPointsInput.value);
                const excludedSkills = parseSkillList(excludedSkillsInput.value);
                
                let calculatedAssignments = { ...manualAssignments };
                const manuallyAssignedNames = new Set(Object.keys(manualAssignments));
                
                // Determine which skills need AI calculation
                const allSkillNames = SKILL_DATA.map(s => s.name);
                const aiRequiredSkills = allSkillNames.filter(name => 
                    !manuallyAssignedNames.has(name)
                );
                
                let aiAssignments = [];

                // 2. Call AI if needed
                if (aiRequiredSkills.length > 0) {
                    statusMessage.textContent = `Analyzing remaining ${aiRequiredSkills.length} skills...`;

                    // Create the prompt for the AI
                    const aiSkillList = aiRequiredSkills.join(', ');
                    let exclusionInstruction = "";

                    // Filter AI exclusions to only include skills the AI is responsible for
                    const aiExclusions = aiRequiredSkills.filter(name => excludedSkills.has(name));
                    if (aiExclusions.length > 0) {
                        exclusionInstruction = ` IMPORTANT CONSTRAINT: DO NOT assign any points (must be 0) to these skills: ${aiExclusions.join(', ')}.`;
                    }

                    const userQuery = `Activity: "${activityText}". Based on this, assign points (0-10) ONLY to the following skills: ${aiSkillList}.${exclusionInstruction}`;

                    const payload = { 
                        contents: [{ parts: [{ text: userQuery }] }],
                        systemInstruction: { parts: [{ text: SYSTEM_INSTRUCTION }] },
                        generationConfig: {
                            responseMimeType: "application/json",
                            responseSchema: RESPONSE_SCHEMA
                        }
                    };

                    const result = await fetchGeminiApi(payload);
                    const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (!jsonText) {
                         console.warn("AI returned no parsable JSON. Skipping AI assignments.");
                    } else {
                        try {
                            aiAssignments = JSON.parse(jsonText);
                        } catch(e) {
                            console.error("Failed to parse AI JSON:", e);
                            statusMessage.textContent = `Warning: AI response failed to parse. Only manual points considered.`;
                        }
                    }
                } else {
                    statusMessage.textContent = "All points were assigned manually. Skipping AI analysis.";
                }

                // 3. Combine All Assignments (Manual + AI)
                aiAssignments.forEach(assignment => {
                    // Only merge if the skill wasn't manually assigned
                    if (!calculatedAssignments.hasOwnProperty(assignment.skillName)) {
                        // Clamp AI points between 0 and 10
                        calculatedAssignments[assignment.skillName] = Math.min(10, Math.max(0, assignment.pointsToAdd));
                    }
                });
                
                // 4. Store and Display Recommendation
                pendingAssignments = calculatedAssignments;
                
                let recommendationHtml = "<strong>Point Recommendation:</strong><br>";
                let pointsFound = false;
                
                Object.keys(pendingAssignments).forEach(skillName => {
                    const points = pendingAssignments[skillName];
                    const skill = SKILL_DATA.find(s => s.name === skillName);

                    if (points > 0 && skill) {
                        // Using dark green for positive points
                        recommendationHtml += `<span style="color: #155724; line-height: 1.5;">${skill.symbol} ${skillName}: +${points}</span><br>`;
                        pointsFound = true;
                    }
                });
                
                // Hide tip elements when showing point assignment
                recommendationText.style.display = 'block';
                recommendationEditor.style.display = 'none'; 
                saveTipsButton.style.display = 'none';
                cancelEditButton.style.display = 'none';
                editTipsButton.style.display = 'none';

                if (!pointsFound) {
                     recommendationHtml = "<strong>No points recommended.</strong>";
                     applyRecommendationButton.disabled = true;
                } else {
                    applyRecommendationButton.disabled = false;
                    applyRecommendationButton.style.display = 'inline-block'; // Show the Apply button
                }

                recommendationText.innerHTML = recommendationHtml;
                recommendationOutput.style.display = 'block';

                statusMessage.textContent = `Analysis complete. Review the recommendation below.`;

                // Clear inputs after successful analysis
                activityTextInput.value = ''; 
                manualPointsInput.value = '';
                excludedSkillsInput.value = '';


            } catch (e) {
                console.error("Error during activity analysis:", e);
                statusMessage.textContent = `Error: Failed to process activity. Check console for details.`;
            } finally {
                analyzeActivityButton.disabled = false;
            }
        }


        // --- EVENT LISTENERS ---
        analyzeActivityButton.addEventListener('click', handleAnalyzeActivityClick);
        applyRecommendationButton.addEventListener('click', applyPendingAssignments);
        editTipsButton.addEventListener('click', () => toggleTipEditMode(true));
        saveTipsButton.addEventListener('click', saveEditedTips);
        cancelEditButton.addEventListener('click', () => toggleTipEditMode(false));
        saveDataButton.addEventListener('click', saveData);


        // Initialize the buttons and Firebase when the page loads
        createButtons();
        initFirebase();
    </script>
</body>
</html>
